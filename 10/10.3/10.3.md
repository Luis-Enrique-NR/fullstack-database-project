# 10.3. Secuencias

## Módulo 01: Proceso Productivo

### Secuencia de codigos

En el módulo de Proceso Productivo se requiere la generación de códigos para los eventos que se realizan por lote de producto. Para darle un formato especial (DS000001, MZ000001, MD000001, SC000001 y EV000001) se utilizará un secuencial que genere los números consecutivos.

```sql
-- Para DOSIFICADOS
CREATE SEQUENCE codigo_dosificado_seq START 1;

CREATE OR REPLACE FUNCTION generar_codigo_dosificado() RETURNS CHAR(9) AS $$
DECLARE num INT;
BEGIN
    num := nextval('codigo_dosificado_seq');
    RETURN 'DS' || LPAD(num::TEXT, 6, '0');
END;
$$ LANGUAGE plpgsql;

-- Para MEZCLADOS
CREATE SEQUENCE codigo_mezclado_seq START 1;

CREATE OR REPLACE FUNCTION generar_codigo_mezclado() RETURNS CHAR(9) AS $$
DECLARE num INT;
BEGIN
    num := nextval('codigo_mezclado_seq');
    RETURN 'MZ' || LPAD(num::TEXT, 6, '0');
END;
$$ LANGUAGE plpgsql;

-- Para MOLDEADOS
CREATE SEQUENCE codigo_moldeado_seq START 1;

CREATE OR REPLACE FUNCTION generar_codigo_moldeado() RETURNS CHAR(9) AS $$
DECLARE num INT;
BEGIN
    num := nextval('codigo_moldeado_seq');
    RETURN 'MD' || LPAD(num::TEXT, 6, '0');
END;
$$ LANGUAGE plpgsql;

-- Para SECADOS
CREATE SEQUENCE codigo_secado_seq START 1;

CREATE OR REPLACE FUNCTION generar_codigo_secado() RETURNS CHAR(9) AS $$
DECLARE num INT;
BEGIN
    num := nextval('codigo_secado_seq');
    RETURN 'SC' || LPAD(num::TEXT, 6, '0');
END;
$$ LANGUAGE plpgsql;

-- Para ENVASADOS
CREATE SEQUENCE codigo_envasado_seq START 1;

CREATE OR REPLACE FUNCTION generar_codigo_envasado() RETURNS CHAR(9) AS $$
DECLARE num INT;
BEGIN
    num := nextval('codigo_envasado_seq');
    RETURN 'EV' || LPAD(num::TEXT, 6, '0');
END;
$$ LANGUAGE plpgsql;
```

### Secuencia de datos ya existentes

```sql
-- Sincronización de códigos
SELECT setval('codigo_dosificado_seq', (SELECT MAX(SUBSTRING(codigo, 3)::INT) FROM Dosificados));
SELECT setval('codigo_mezclado_seq',   (SELECT MAX(SUBSTRING(codigo, 3)::INT) FROM Mezclados));
SELECT setval('codigo_moldeado_seq',   (SELECT MAX(SUBSTRING(codigo, 3)::INT) FROM Moldeados));
SELECT setval('codigo_secado_seq',     (SELECT MAX(SUBSTRING(codigo, 3)::INT) FROM Secados));
SELECT setval('codigo_envasado_seq',   (SELECT MAX(SUBSTRING(codigo, 3)::INT) FROM Envasados));

-- Sincronización de ids
SELECT setval('dosificados_id_dosificado_seq', (SELECT MAX(id_dosificado) FROM Dosificados));
SELECT setval('envasados_id_envasado_seq', (SELECT MAX(id_envasado) FROM Envasados));
```

## Módulo 02: Almacen de Insumos

En el módulo de Alamacen de Insumos requiere la generación de códigos para las Recepeciones de Insumo y Abastecimieto de Insumos. Para darle un formato especial (RX999999 o AB999999) se utilizará un secuencial que genere los números consecutivos.

```sql
--Recepcion de Insumos
--Creacion de la secuencia
DROP SEQUENCE IF EXISTS codigo_recepcion_insumos_seq;
CREATE SEQUENCE codigo_recepcion_insumos_seq START 1;

--Funcion que genera codigos de recepciones
CREATE OR REPLACE FUNCTION generar_codigo_recepcion_insumos()
RETURNS CHAR(10) AS $$
DECLARE
    num INT;
BEGIN
    num := nextval('codigo_recepcion_insumos_seq');
RETURN 'RX' || LPAD(num::TEXT, 6, '0');
END;
$$ LANGUAGE plpgsql;

--Sincronizacion con los codigos actuales
SELECT setval('codigo_recepcion_insumos_seq', (SELECT MAX(SUBSTRING(codigo, 3)::INT) FROM recepciones ));

--Abastecimiento de Insumos
--Creacion de la secuencia
DROP SEQUENCE IF EXISTS codigo_abastecimiento_insumos_seq;
CREATE SEQUENCE codigo_abastecimiento_insumos_seq START 1;

--Funcion que genera codigos de abastecimientos 
CREATE OR REPLACE FUNCTION generar_codigo_abastecimiento_insumos()
RETURNS CHAR(10) AS $$
DECLARE
    num INT;
BEGIN
    num := nextval('codigo_abastecimiento_insumos_seq');
RETURN 'AB' || LPAD(num::TEXT, 6, '0');
END;
$$ LANGUAGE plpgsql;

--Sincronizacion con los codigos actuales
SELECT setval('codigo_abastecimiento_insumos_seq', (SELECT MAX(SUBSTRING(codigo, 3)::INT) FROM abastecimientos));

--Solicitud de Abastecimiento
--Creacion de la secuencia
DROP SEQUENCE IF EXISTS codigo_solicitud_insumos_seq;
CREATE SEQUENCE codigo_solicitud_insumos_seq START 1;

--Funcion que genera codigos de solicitudes
CREATE OR REPLACE FUNCTION generar_codigo_solicitud_insumos()
RETURNS CHAR(10) AS $$
DECLARE
    num INT;
BEGIN
    num := nextval('codigo_solicitud_insumos_seq');
RETURN 'SA' || LPAD(num::TEXT, 6, '0');
END;
$$ LANGUAGE plpgsql;

--Sincronizacion con los codigos actuales
SELECT setval('codigo_solicitud_insumos_seq', (SELECT MAX(SUBSTRING(codigo, 3)::INT) FROM solicitudesabastecimiento ));
```

## Módulo 03: Control de Calidad

## Secuencia: `seq_codigo_inspeccion`

Genera un número incremental para usar en el código de inspección.

```sql
CREATE SEQUENCE seq_codigo_inspeccion
START 1
INCREMENT 1
MINVALUE 1
OWNED BY NONE;
```

**Uso**: se concatena con el prefijo `IG` desde el backend para obtener códigos como `IG00001`, `IG00002`, etc.


## Módulo 04: Compras

### Secuencia 1: seq_compras_id

* **Tabla asociada:** Compras

* **Campo:** id_compra

* **Justificación:** Permite la asignación secuencial y única de cada proceso de compra realizado, útil para la trazabilidad desde la planificación hasta la recepción de insumos.

* **SQL:**

```sql
CREATE SEQUENCE seq_compras_id
  START WITH 1
  INCREMENT BY 1
  NO MINVALUE
  NO MAXVALUE
  CACHE 1;

ALTER TABLE Compras
  ALTER COLUMN id_compra SET DEFAULT nextval('seq_compras_id');
```

### Secuencia 2: seq_ordenescompra_id

* **Tabla asociada:** OrdenesCompra

* **Campo:** id_orden_compra

* **Justificación:** Genera identificadores únicos para cada orden de compra emitida, garantizando su trazabilidad y referencia tanto para procesos internos como para comunicación con proveedores.

* **SQL:**

```sql
CREATE SEQUENCE seq_ordenescompra_id
  START WITH 1
  INCREMENT BY 1
  NO MINVALUE
  NO MAXVALUE
  CACHE 1;

ALTER TABLE OrdenesCompra
  ALTER COLUMN id_orden_compra SET DEFAULT nextval('seq_ordenescompra_id');
```

### Secuencia 3: seq_seguimientoscompra_id

* **Tabla asociada:** SeguimientosCompra

* **Campo:** id_seguimiento_compra

* **Justificación:** Controla la numeración de cada registro de seguimiento relacionado a una compra, necesario para auditoría del flujo logístico y estados de entrega.

* **SQL:**

```sql
CREATE SEQUENCE seq_seguimientoscompra_id
  START WITH 1
  INCREMENT BY 1
  NO MINVALUE
  NO MAXVALUE
  CACHE 1;

ALTER TABLE SeguimientosCompra
  ALTER COLUMN id_seguimiento_compra SET DEFAULT nextval('seq_seguimientoscompra_id');
```

## Módulo 06: Distribución

En el módulo de Distribución se requiere la generación de códigos para las órdenes de carga y programaciones de despacho. Para darle un formato especial (PRG9999999 o OC99999) se utilizará un secuencial que genere los números consecutivos.

```sql
-- Programaciones de Despacho
CREATE SEQUENCE codigo_prog_desp_seq START 1;

CREATE FUNCTION generar_codigo_prog_desp()
RETURNS CHAR(10) AS $$
DECLARE
    num INT;
BEGIN
    num := nextval('codigo_prog_desp_seq');
RETURN 'PRG' || LPAD(num::TEXT, 5, '0');
END;
$$ LANGUAGE plpgsql;

-- Órdenes de Carga
CREATE SEQUENCE codigo_ord_carga_seq START 1;

CREATE FUNCTION generar_codigo_ord_carga()
RETURNS CHAR(9) AS $$
DECLARE
    num INT;
BEGIN
    num := nextval('codigo_ord_carga_seq');
RETURN 'OC' || LPAD(num::TEXT, 5, '0');
END;
$$ LANGUAGE plpgsql;
```
