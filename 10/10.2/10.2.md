# 10.2. Vistas

## Módulo 2: Almacen de Insumos

### Vista : vista_producto_cantidad_max_unitario

* **Objetivo:** Consultar la cantidad de unitaria maxima de un producto en su formalacion comun, uniendo las tablas de productos, formulacion, dellesformulacion, insumos. 

* **Justificación:** La vista se utiliza en el prototipo abastecimiento de Insumos reduciendo la consulta de una funcion compleja a una seleccion simple de una vista ya creada y es una vista eficiente ya que las tablas utilizadas no sufren modificaciones continuas.

* **SQL:**

```sql
create or replace view vista_producto_cantidad_max_unitario as 
select p.id_producto ,p.codigo, p.nombre, d.cantidad_asignada as Cantidad_max_unitaro from productos p 
join formulaciones f 
on f.id_producto = p.id_producto 
join detallesformulacion d 
on d.id_formulacion = f.id_formulacion 
join insumos i 
on i.id_insumo = d.id_insumo 
where i.id_insumo in (11,12);
```


## Módulo 3: Control de Calidad

### Vista: `vista_historial_inspecciones_proceso`

Permite consultar inspecciones de proceso con detalle de estado, tipo, lote y fecha.

```sql
CREATE OR REPLACE VIEW vista_historial_inspecciones_proceso AS
SELECT 
    ig.codigo AS cod_inspeccion,
    pr.numero_batch,
    lp.codigo AS cod_lote_producto,
    ip.tipo_proceso,
    pr.estado AS estado_proceso,
    ig.fecha_hora_inspeccion::date AS fecha_inspeccion,
    ig.fecha_hora_inspeccion::time AS hora_inspeccion
FROM InspeccionesGenerales ig
JOIN InspeccionesProceso ip ON ig.id_inspeccion = ip.id_inspeccion
JOIN ProcesosRecurrente pr ON ip.id_proceso_recurrente = pr.id_proceso_recurrente
JOIN LotesProducto lp ON pr.id_lote_producto = lp.id_lote_producto;
```

**Justificación**: simplifica la consulta combinada de múltiples entidades para visualización en el historial de inspecciones.


## Módulo 4: Compras

### Vista 1: vista_proveedores_resumen

* **Objetivo:** Consolidar la información de los proveedores registrados, incluyendo su nombre comercial, RUC, contacto y estado.

* **Justificación:** Utilizada en interfaces como “Consultar Proveedores” (I-401) y “Actualizar datos de Proveedores” (I-403) para mostrar información clave de forma directa y sin joins adicionales.

* **SQL:**

```sql
CREATE VIEW vista_solicitudes_abastecimiento AS
SELECT
  sa.id_solicitud,
  sa.codigo,
  sa.estado_solicitud,
  sa.fecha_solicitud,
  u.nombre_usuario AS solicitado_por
FROM SolicitudesAbastecimiento sa
JOIN Usuarios u ON sa.id_usuario = u.id_usuario;
```

### Vista 2: vista_ordenes_compra_detalle

* **Objetivo:** Combinar información de órdenes de compra, propuestas y proveedores en una sola vista.

* **Justificación:** Permite mostrar el detalle completo de una orden en la interfaz “Revisar Detalles de Solicitud de Abastecimiento” (I-405) y “Enviar Orden de Compra” (I-409) de manera eficiente.

* **SQL:**

```sql
CREATE VIEW vista_ordenes_compra_detalle AS
SELECT
  oc.id_orden_compra,
  oc.codigo,
  oc.estado,
  pc.codigo AS codigo_propuesta,
  p.nombre_comercial AS proveedor
FROM OrdenesCompra oc
JOIN PropuestasCompra pc ON oc.id_propuesta = pc.id_propuesta
JOIN Proveedores p ON pc.id_proveedor = p.id_proveedor;
```

## Módulo 5: Control de Producción

Para facilitar la asociación directa entre lote de producto y al producto que corresponde se crea la siguiente vista no materializada (se irá actualizando)
```sql
create view Info_Lote_Producto as
select l.id_lote_producto, p.id_producto, l.cantidad_producida 
from productos p 
inner join solicitudesproduccion s on s.id_producto = p.id_producto 
inner join ordenesproduccion o on o.id_solicitud_produccion = s.id_solicitud_produccion 
inner join lotesproducto l on l.id_orden_produccion = o.id_orden_produccion 
group by l.id_lote_producto, p.id_producto  
order by l.id_lote_producto;
```
